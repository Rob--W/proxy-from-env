on: [ push, pull_request, workflow_dispatch ]

name: Tests

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-node@v6
    - run: npm install # install eslint
    - run: npm run lint

  test-node:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node_version: [ 20 ]
    steps:
    - uses: actions/checkout@v6

    - name: Use Node.js ${{ matrix.node_version }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node_version }}

    # Note: no npm ci / npm install:
    # The package has no non-dev dependencies.
    # We rely on Node.js's built-in test module and reporter,
    # and do not require any dev dependencies either.

    # test-coverage will also run the tests, but does not print helpful output upon test failure.
    # So we also run the tests separately.
    - run: npm test

    # note: --experimental-test-coverage requires Node v18.15.0+
    # note: --test-reporter=lcov requires Node v20.11.0+ (https://github.com/nodejs/node/pull/50018)
    - run: npm run test-coverage

    - name: Send coverage for Node ${{ matrix.node_version }} to Coveralls
      uses: coverallsapp/github-action@v2
      with:
        parallel: true
        file: lcov.info
        flag-name: coverage-node-${{ matrix.node_version }}

  coveralls:
    name: Report to Coveralls
    needs: [ test-old-node, test-recent-node ]
    if: ${{ github.repository == 'Rob--W/proxy-from-env' }}
    runs-on: ubuntu-latest
    steps:
    - uses: coverallsapp/github-action@v2
      with:
        parallel-finished: true
